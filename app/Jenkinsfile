pipeline {
    agent any
    environment {
        REGISTRY = 'mbarrionuevok8s'
        DOCKER_HUB_LOGIN = credentials('dockerHub')
        RESULT = 'app/result'
        VOTE = 'app/vote'
        WORKER = 'app/worker'
    }
    stages {
        stage('version') {
            steps {
                sh '''
                        changelog_file='app/CHANGELOG.md'
                        version_pattern='## \\[[0-9]*\\.[0-9]*\\.[0-9]*\\]'
                        version_line=\$(grep -E "\$version_pattern" "\$changelog_file" | head -n 1)
                        version=\$(echo "\$version_line" | grep -oE "[0-9]*\\.[0-9]*\\.[0-9]*")
                        echo "Versi√≥n encontrada en el changelog: \$version"
                    '''
            }
        }

        stage('Build') {
            parallel {
                stage('result') {
                    steps {
                        dir("$RESULT") {
                            sh """
                                echo ${version}
                                docker build -t $REGISTRY/${version} .
                            """
                        }
                    }
                }
            }
        }
