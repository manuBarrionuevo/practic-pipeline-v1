pipeline {
    agent any
    environment {
        REGISTRY = 'manuelbarrionuevo'
        DOCKER_HUB_LOGIN = credentials('docker')
        CARPETA='app'
        REPO_URL='https://github.com/manuBarrionuevo/jekins.git'
    }
    stages { // el principal donde se arman la tuberia CI
        stage('GitClone')
        {
                    steps {
                sh '''
                    if [ -d "\$CARPETA" ]; then
                        echo "La carpeta ya está creada"
                    else
                        git clone "\$REPO_URL"
                            if [ \$? -eq 0 ]; then
                                echo "Se clonó la carpeta"
                            else
                                echo "Error al clonar la carpeta"
                            fi
                    fi
                    ls -la
                    '''
                    }
        }

        stage('Build') {
            parallel {
                stage('result')
                {
                    steps {
                            sh '''
                                cd $CARPETA/result
                                docker build -t result:v1 .
                            '''
                    }
                }
                stage('vote')
                {
                        steps {
                                sh '''
                                    cd $CARPETA/vote
                                    docker build -t vote:v1 .
                                '''
                            }
                }
                stage('worker')
                {
                    steps {
                        sh  '''
                        cd $CARPETA/worker
                        docker build -t worker:v1 .
                    '''
                    }
                }
            }
        }
        stage('deploy'){
            steps{
                sh  '''
                    docker login --username=$DOCKER_HUB_LOGIN_USR --password=$DOCKER_HUB_LOGIN_PSW
                    docker images
                    docker push $REGISTRY/result:v1
                    docker push $REGISTRY/vote:v1
                    docker push $REGISTRY/worker:v1
                    '''
            }
        }
    } //fin stage principal
}
